<?php
// $Id$
// Original module written by Marco Scutari.
// Rewritten and considerably shortened and made more Drupal-friendly
// by Earl Miles.

function paging_help($section) {
  switch ($section) {
    case 'admin/help#paging':
      return t("<p>Break long pages into smaller ones by means of " .
               "a \"page\" tag:</p>\n" .
               "<pre>\n" .
               "first page here.\n" .
               "&lt;!--pagebreak--&gt;\n" .
               "second page here.\n" .
               "&lt;!--pagebreak--&gt;\n" .
               "more pages here.\n");
    case 'admin/modules#description':
      return t("Allow users to use a tag to break a node up into multiple pages.");
  }
}

function paging_nodeapi(&$node, $op, $teaser = NULL, $page = NULL) {
  switch ($op) {

    case 'load':
      // Set up our pages on load.
      $node->pages = explode("<!--pagebreak-->", $node->body);
      $node->pages_count = count($node->pages);
      break;
    case 'view':
      if (!$node->in_preview) {
        $element = 1; // to try and avoid breaking with comments
        // check paging is really needed and avoid paging
        // printer friendly pages as well.
        if (!$teaser && $node->pages_count > 1 && arg(2) != 'print' && arg(2) != 'full') {
          global $pager_page_array, $pager_total;
          $page = isset($_GET['page']) ? $_GET['page'] : '';
          $pager_page_array = explode(',', $page);
          $pager_total[$element] = $node->pages_count;
          $page = isset($pager_page_array[$element]) ? $pager_page_array[$element] : 0;
          $node->body = check_markup($node->pages[$page], $node->format, false);
          $node->body .= theme('pager', NULL, 1, $element);
        }
        elseif ($teaser && $node->pages_count > 1 && strlen($node->teaser) > strlen($node->pages[0])) {
          // check to see if the teaser is longer than our first page.
          $node->teaser = check_markup($node->pages[0], $node->format, false);
          $node->readmore = true;
        }
      }
  }
}
